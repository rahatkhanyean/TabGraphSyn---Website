{% extends "base.html" %}
{% load static %}

{% block title %}Generate Synthetic Data{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/upload.css' %}" />
{% endblock %}

{% block content %}
    {% if form.non_field_errors %}
        <div class="error-banner">
            {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <div class="page-header">
        <div>
            <h1>Generate Synthetic Data</h1>
            <p class="page-subtitle">Upload your CSV file and let AI create privacy-preserving synthetic data</p>
        </div>
    </div>

    <div class="journey-layout">
        <form method="post" enctype="multipart/form-data" class="journey-form">
            {% csrf_token %}
            {{ form.staging_token }}

            <div class="journey-flow">
                <!-- BASIC MODE: Upload CSV Section (Always Visible) -->
                <section class="journey-step">
                    <div class="journey-step-header">
                        <div>
                            <h2 class="journey-step-title">Upload Your CSV Dataset</h2>
                            <p class="journey-step-copy">Upload your patient data CSV - we'll handle the rest automatically</p>
                        </div>
                    </div>
                    <div class="journey-step-body">
                        <div class="field-row">
                            <div>
                                <label class="field-label" for="dataset-file">CSV file</label>
                                <input type="file" id="dataset-file" class="input-control" accept=".csv,text/csv" required />
                                <p class="field-help">Upload a CSV to automatically profile columns and detect types</p>
                            </div>
                        </div>
                        <div class="field-row">
                            <div id="upload-summary" class="field-help" hidden></div>
                        </div>

                        <!-- Status Indicator (Basic Mode) -->
                        <div id="basic-mode-status" style="margin-top: 20px; padding: 12px; border-radius: 8px; display: none;">
                            <p id="basic-status-message" style="margin: 0; font-weight: 500;"></p>
                        </div>

                        <!-- Run Button (Basic Mode) -->
                        <div class="journey-actions" style="margin-top: 32px;">
                            <button type="submit" class="primary-button" id="run-button" disabled>
                                <i class="fa-solid fa-play"></i>
                                Run Pipeline
                            </button>
                            <button type="button" id="toggle-advanced-options" class="link-button" style="margin-left: 16px;">
                                <span id="advanced-toggle-icon">â–¶</span> Show Advanced Options
                            </button>
                        </div>
                    </div>
                </section>

                <!-- ADVANCED MODE: All Advanced Options (Hidden by Default) -->
                <div id="advanced-options-container" class="advanced-options" hidden>

                    <!-- Data Source Selection -->
                    <div class="advanced-section">
                        <h3 class="subsection-title">Data Source</h3>
                        <p class="inline-hint">Choose between uploading custom CSV or using preloaded datasets</p>

                        <div class="radio-stack" id="data-source-options">
                            {% for radio in form.data_source %}
                                <label class="radio-option">
                                    {{ radio.tag }} <span class="info">{{ radio.choice_label }}</span>
                                </label>
                            {% endfor %}
                        </div>

                        <!-- Preloaded Dataset Options -->
                        <div id="preloaded-options" class="metadata-panel" hidden style="margin-top: 16px;">
                            <div class="field-row">
                                <div>
                                    <label class="field-label" for="{{ form.dataset.id_for_label }}">Dataset</label>
                                    {{ form.dataset }}
                                    {% if form.dataset.errors %}<ul class="errorlist">{% for error in form.dataset.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                                </div>
                                <div>
                                    <label class="field-label" for="{{ form.metadata_template.id_for_label }}">Metadata template</label>
                                    {{ form.metadata_template }}
                                    {% if form.metadata_template.errors %}<ul class="errorlist">{% for error in form.metadata_template.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                                </div>
                            </div>
                            <p class="inline-hint">Templates automatically align column semantics to the target table</p>
                        </div>
                    </div>

                    <!-- Metadata Configuration (shown after upload) -->
                    <div id="advanced-metadata-section" class="advanced-section" hidden>
                        <h3 class="subsection-title">Metadata Configuration</h3>
                        <p class="inline-hint">Review inferred columns, adjust types, and nominate a primary key</p>

                        <div class="radio-stack" id="metadata-mode-options">
                            {% for radio in form.metadata_mode %}
                                <label class="radio-option">
                                    {{ radio.tag }} {{ radio.choice_label }}
                                </label>
                            {% endfor %}
                        </div>

                        <!-- Template Selection -->
                        <div id="metadata-template-panel" class="metadata-panel" hidden style="margin-top: 16px;">
                            <label class="field-label" for="template-select">Available templates</label>
                            <select id="template-select" class="input-control"></select>
                            <p class="field-help">Choose a packaged schema that matches your upload</p>
                        </div>

                        <!-- Custom Metadata Table -->
                        <div id="metadata-custom-panel" class="metadata-panel" hidden style="margin-top: 16px;">
                            <div class="table-wrapper">
                                <table id="column-summary" class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Column</th>
                                            <th>Detected</th>
                                            <th>Missing?</th>
                                            <th>Kind</th>
                                            <th>Representation</th>
                                            <th>Primary key</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                            <button type="button" class="secondary-button" id="finalize-metadata-button" disabled hidden style="margin-top: 16px;">
                                Apply metadata changes
                            </button>
                            <p class="field-help" id="finalize-status"></p>
                        </div>
                    </div>

                    <!-- Training Parameters Section -->
                    <div class="advanced-section">
                        <h3 class="subsection-title">Training Parameters</h3>
                        <div class="field-row">
                            <div>
                                <label class="field-label" for="{{ form.epochs_vae.id_for_label }}">VAE epochs</label>
                                {{ form.epochs_vae }}
                                {% if form.epochs_vae.errors %}<ul class="errorlist">{% for error in form.epochs_vae.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                            <div>
                                <label class="field-label" for="{{ form.epochs_gnn.id_for_label }}">GNN epochs</label>
                                {{ form.epochs_gnn }}
                                {% if form.epochs_gnn.errors %}<ul class="errorlist">{% for error in form.epochs_gnn.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                            <div>
                                <label class="field-label" for="{{ form.epochs_diff.id_for_label }}">Diffusion epochs</label>
                                {{ form.epochs_diff }}
                                {% if form.epochs_diff.errors %}<ul class="errorlist">{% for error in form.epochs_diff.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Epoch-wise Evaluation Section -->
                    <div class="advanced-section">
                        <h3 class="subsection-title">Epoch-wise Evaluation</h3>
                        <p class="inline-hint">Track marginal distribution and pairwise correlation errors during training</p>
                        <div class="field-group">
                            <div>
                                <label class="field-label checkbox-label">
                                    {{ form.enable_epoch_eval }}
                                    <span>{{ form.enable_epoch_eval.label }}</span>
                                </label>
                                {% if form.enable_epoch_eval.help_text %}
                                <p class="field-help">{{ form.enable_epoch_eval.help_text }}</p>
                                {% endif %}
                                {% if form.enable_epoch_eval.errors %}<ul class="errorlist">{% for error in form.enable_epoch_eval.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                        </div>
                        <div class="field-group epoch-eval-options" style="margin-top: 16px;">
                            <div>
                                <label class="field-label" for="{{ form.eval_frequency.id_for_label }}">{{ form.eval_frequency.label }}</label>
                                {{ form.eval_frequency }}
                                {% if form.eval_frequency.help_text %}
                                <p class="field-help">{{ form.eval_frequency.help_text }}</p>
                                {% endif %}
                                {% if form.eval_frequency.errors %}<ul class="errorlist">{% for error in form.eval_frequency.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                            <div>
                                <label class="field-label" for="{{ form.eval_samples.id_for_label }}">{{ form.eval_samples.label }}</label>
                                {{ form.eval_samples }}
                                {% if form.eval_samples.help_text %}
                                <p class="field-help">{{ form.eval_samples.help_text }}</p>
                                {% endif %}
                                {% if form.eval_samples.errors %}<ul class="errorlist">{% for error in form.eval_samples.errors %}<li>{{ error }}</li>{% endfor %}</ul>{% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Command Preview Section -->
                    <div class="advanced-section">
                        <h3 class="subsection-title">Command Preview</h3>
                        <p class="inline-hint">The orchestrator will execute:</p>
                        <code id="command-preview">{{ command_preview }}</code>
                    </div>
                </div>
            </div>
        </form>
        <aside class="journey-sidebar">
            <div class="tips-card">
                <h3>Quick tips</h3>
                <ul>
                    <li>Upload a CSV to automatically detect column types and configurations</li>
                    <li>Use Basic mode for quick runs with default settings</li>
                    <li>Expand Advanced Options to customize epochs and metadata</li>
                    <li>Keep the page open during generation to track progress</li>
                </ul>
            </div>
        </aside>
    </div>
{% endblock %}

{% block extra_scripts %}
    {{ defaults|json_script:"pipeline-defaults" }}
    {{ api_urls|json_script:"synthetic-api-urls" }}
    <script src="{% static 'js/upload.js' %}"></script>
{% endblock %}
