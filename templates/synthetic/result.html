{% extends "base.html" %}
{% load static %}

{% block title %}TabGraphSyn Run{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/result.css' %}" />
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
<style>
    /* Inline fallback to guarantee side-by-side dashboard even if cached CSS is stale */
    .result-dashboard {
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 28px;
        align-items: flex-start;
        margin-top: 32px;
    }
    .dashboard-column {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 24px;
    }
    .umap-card .umap-plot-container,
    .umap-card .image-wrapper,
    .umap-card .empty-state {
        margin-top: 16px;
    }
    @media (max-width: 900px) {
        .result-dashboard {
            grid-template-columns: 1fr;
            gap: 24px;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Hidden data attribute for run token -->
    <div data-run-token="{{ run_token }}" style="display: none;"></div>

    <div class="result-layout">
        <div class="result-main">
            <section class="card" highlight-card>
                <div class="card-header">
                    <div>
                        <div class="card-title"><i class="fa-solid fa-angle-left"></i> Summary</div>
                        <div class="card-subtitle">Snapshot of configuration and outputs.</div>
                    </div>
                </div>
                <div class="highlight-grid">
                    <div class="stat-tile">
                        <span class="stat-label">Data source</span>
                        <span class="stat-value">{{ metadata.data_source|default:"preloaded"|capfirst }}</span>
                    </div>
                    <div class="stat-tile">
                        <span class="stat-label">Dataset</span>
                        <span class="stat-value">{{ metadata.dataset }}</span>
                    </div>
                    <div class="stat-tile">
                        <span class="stat-label">Table</span>
                        <span class="stat-value">{{ metadata.table }}</span>
                    </div>
                    <div class="stat-tile">
                        <span class="stat-label">Generated rows</span>
                        <span class="stat-value">{{ metadata.generated_rows|default:"n/a" }}</span>
                    </div>
                </div>
                <div class="action-row">
                    {% if has_output %}
                        <a href="{{ download_url }}" class="primary-button">Download synthetic CSV</a>
                    {% else %}
                        <span class="secondary-button" is-disabled aria-disabled="true">No synthetic CSV for this run</span>
                    {% endif %}
                    <a href="{% url 'synthetic:upload' %}" class="secondary-button">Run another experiment</a>
                </div>
            </section>

            <div class="result-dashboard">
                <div class="dashboard-column dashboard-left">
                    <section class="card data-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Preview (first 20 rows)</div>
                                <div class="card-subtitle">Sanity check the generated records before downstream use. Hover over a row to see it highlighted in the UMAP panel on the right.</div>
                            </div>
                        </div>
                        {% if has_output and preview_rows %}
                            <div class="table-wrapper">
                                <table class="data-table data-preview-table">
                                    <thead>
                                        <tr>
                                            {% for header in preview_headers %}
                                                <th>{{ header }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for row in preview_rows %}
                                            <tr>
                                                {% for cell in row %}
                                                    <td>{{ cell }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if metadata.generated_rows > 20 %}
                                <div class="action-row" style="margin-top: 16px;">
                                    <button id="toggle-data-view" class="secondary-button" style="display: none;">
                                        <i class="fa-solid fa-expand"></i> View All Data
                                    </button>
                                </div>
                            {% endif %}
                        {% elif has_output %}
                            <p class="empty-state">Synthetic file generated, but no rows were returned.</p>
                        {% else %}
                            <p class="empty-state">This mode does not produce a sample file. Check the evaluation summary above for status.</p>
                        {% endif %}
                    </section>
                </div>

                <div class="dashboard-column dashboard-right">
                    {% if evaluation and evaluation.status == 'success' %}
                        {% if umap_coordinates or evaluation_plot_data_uri or evaluation_plot_path %}
                        <section class="card umap-card">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">UMAP Projection</div>
                                    <div class="card-subtitle">Track how each synthetic record (hover on the left table) maps into embedding space.</div>
                                </div>
                            </div>
                            {% if umap_coordinates %}
                                <div class="umap-plot-container">
                                    <div id="interactive-umap-plot" style="width: 100%; height: 600px;"></div>
                                </div>
                                <script id="umap-data" type="application/json">{{ umap_coordinates|safe }}</script>
                            {% elif evaluation_plot_data_uri %}
                                <div class="image-wrapper">
                                    <img src="{{ evaluation_plot_data_uri }}" alt="UMAP projection">
                                </div>
                            {% elif evaluation_plot_path %}
                                <p class="empty-state" style="margin-top: 16px;">UMAP plot saved at {{ evaluation_plot_path }}.</p>
                            {% endif %}
                            {% if evaluation_download_url %}
                                <div class="action-row" style="margin-top: 16px;">
                                    <a href="{{ evaluation_download_url }}" class="secondary-button">Download UMAP PNG</a>
                                </div>
                            {% endif %}
                        </section>
                        {% endif %}
                    {% endif %}

                    {% if evaluation %}
                    <section class="card evaluation-metrics-card" evaluation-card>
                        <div class="card-header">
                            <div>
                                <div class="card-title">Evaluation Metrics</div>
                                <div class="card-subtitle">Quantitative assessment of the synthetic cohort.</div>
                            </div>
                        </div>
                        {% if evaluation.status == 'success' %}
                            {% if evaluation_rows %}
                                <div class="table-wrapper">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                {% for header in evaluation_headers %}
                                                    <th>{{ header }}</th>
                                                {% endfor %}
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for row in evaluation_rows %}
                                                <tr>
                                                    {% for cell in row %}
                                                        <td>{{ cell }}</td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="empty-state">Evaluation completed but did not return any metrics.</p>
                            {% endif %}
                        {% else %}
                            <p class="empty-state">Evaluation unavailable: {{ evaluation.error|default:"See run details for more information." }}</p>
                        {% endif %}
                    </section>
                    {% endif %}

                    {% if epoch_metrics %}
                    <section class="card epoch-metrics-card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Training Progress</div>
                                <div class="card-subtitle">Epoch-wise error metrics tracked during diffusion training.</div>
                            </div>
                        </div>
                        <div class="epoch-metrics-info">
                            <p style="margin: 0 0 16px; color: var(--text-muted); font-size: 14px;">
                                Evaluated every <strong>{{ epoch_metrics.eval_frequency }}</strong> epochs using <strong>{{ epoch_metrics.num_eval_samples }}</strong> synthetic samples.
                            </p>
                        </div>
                        <div class="charts-grid">
                            <div class="chart-container">
                                <canvas id="marginalErrorChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <canvas id="pairwiseErrorChart"></canvas>
                            </div>
                        </div>
                        <div class="action-row" style="margin-top: 20px;">
                            <button type="button" class="secondary-button compact" onclick="downloadChart('marginalErrorChart', 'marginal_error_chart.png')">Download Marginal Chart</button>
                            <button type="button" class="secondary-button compact" onclick="downloadChart('pairwiseErrorChart', 'pairwise_error_chart.png')">Download Pairwise Chart</button>
                        </div>
                    </section>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<!-- Result page interactive features -->
<script src="{% static 'js/result.js' %}"></script>

{% if epoch_metrics %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// Epoch metrics data from Django
const epochMetricsData = JSON.parse('{{ epoch_metrics_json|escapejs }}');

// Extract data for charts
const epochs = [];
const marginalErrors = [];
const pairwiseErrors = [];
const trainingLosses = [];

epochMetricsData.forEach(entry => {
    epochs.push(entry.epoch);
    marginalErrors.push(entry.marginal_error || null);
    pairwiseErrors.push(entry.pairwise_error || null);
    trainingLosses.push(entry.train_loss || null);
});

// Chart configuration
const chartConfig = {
    type: 'line',
    options: {
        responsive: true,
        maintainAspectRatio: true,
        aspectRatio: 2,
        interaction: {
            mode: 'index',
            intersect: false,
        },
        plugins: {
            legend: {
                display: true,
                position: 'top',
                labels: {
                    font: {
                        size: 13,
                        family: 'Inter, sans-serif'
                    },
                    padding: 15,
                    usePointStyle: true,
                }
            },
            tooltip: {
                backgroundColor: 'rgba(15, 23, 42, 0.95)',
                titleColor: '#fff',
                bodyColor: '#e2e8f0',
                borderColor: '#6366f1',
                borderWidth: 1,
                padding: 12,
                displayColors: true,
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) {
                            label += ': ';
                        }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toFixed(4);
                        }
                        return label;
                    }
                }
            }
        },
        scales: {
            x: {
                title: {
                    display: true,
                    text: 'Epoch',
                    font: {
                        size: 14,
                        weight: '600',
                        family: 'Inter, sans-serif'
                    },
                    padding: {top: 10}
                },
                grid: {
                    display: true,
                    color: 'rgba(148, 163, 184, 0.1)',
                },
                ticks: {
                    font: {
                        size: 12,
                        family: 'Inter, sans-serif'
                    }
                }
            },
            y: {
                beginAtZero: false,
                title: {
                    display: true,
                    text: 'Score',
                    font: {
                        size: 14,
                        weight: '600',
                        family: 'Inter, sans-serif'
                    },
                    padding: {bottom: 10}
                },
                grid: {
                    display: true,
                    color: 'rgba(148, 163, 184, 0.1)',
                },
                ticks: {
                    font: {
                        size: 12,
                        family: 'Inter, sans-serif'
                    }
                }
            }
        }
    }
};

// Marginal Error Chart
const marginalCtx = document.getElementById('marginalErrorChart').getContext('2d');
const marginalChart = new Chart(marginalCtx, {
    ...chartConfig,
    data: {
        labels: epochs,
        datasets: [
            {
                label: 'Marginal Distribution Error (Column Shapes)',
                data: marginalErrors,
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#6366f1',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                fill: true,
            },
            {
                label: 'Training Loss',
                data: trainingLosses,
                borderColor: '#f97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: '#f97316',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                fill: false,
                yAxisID: 'y',
            }
        ]
    }
});

// Pairwise Error Chart
const pairwiseCtx = document.getElementById('pairwiseErrorChart').getContext('2d');
const pairwiseChart = new Chart(pairwiseCtx, {
    ...chartConfig,
    data: {
        labels: epochs,
        datasets: [
            {
                label: 'Pairwise Correlation Error (Column Pair Trends)',
                data: pairwiseErrors,
                borderColor: '#8b5cf6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                borderWidth: 3,
                tension: 0.4,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#8b5cf6',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                fill: true,
            },
            {
                label: 'Training Loss',
                data: trainingLosses,
                borderColor: '#f97316',
                backgroundColor: 'rgba(249, 115, 22, 0.1)',
                borderWidth: 2,
                borderDash: [5, 5],
                tension: 0.4,
                pointRadius: 3,
                pointHoverRadius: 5,
                pointBackgroundColor: '#f97316',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                fill: false,
                yAxisID: 'y',
            }
        ]
    }
});

// Download chart as PNG
function downloadChart(chartId, filename) {
    const canvas = document.getElementById(chartId);
    const url = canvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.download = filename;
    link.href = url;
    link.click();
}
</script>
{% endif %}
{% endblock %}
